/* ============================================================
   ЁЯФС adminLogin.js тАФ v9.1AтАвCoreLogic
   ------------------------------------------------------------
   рдпрд╣ рдлрд╝рд╛рдЗрд▓ рдПрдбрдорд┐рди рд▓реЙрдЧрд┐рди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддреА рд╣реИред
   рдЗрд╕рдореЗрдВ рд╕рдЦрд╛ (Moral AI Core) рдФрд░ Security Controller рджреЛрдиреЛрдВ рдХреЗ
   рд╕рд╛рде рддреНрд░рд┐-рд╕реНрддрд░реАрдп рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рдгрд╛рд▓реА рдХрд╛рд░реНрдпрд░рдд рд╣реИред
   ------------------------------------------------------------
   тЬЕ рддреАрди рдкрд░рддреЗрдВ:
      1я╕ПтГг рд╕рдЦрд╛ рд╡реНрдпрд╡рд╣рд╛рд░ рдЬрд╛рдВрдЪ (Behavioral AI Check)
      2я╕ПтГг рдорд╛рд╕реНрдЯрд░ рдХреА рдпрд╛ рдкрд╛рд╕рд╡рд░реНрдб рдкреНрд░рдорд╛рдгреАрдХрд░рдг
      3я╕ПтГг OTP / рд╕реЗрд╢рди рдЯреЛрдХрди рдкреБрдирдГ рд╕рддреНрдпрд╛рдкрди
   ============================================================ */

console.log("ЁЯЯб Admin Login Core Loaded...");

// ЁЯМ╕ рд╕рдЦрд╛ рд╕реЗ рд╕рдВрд╡рд╛рдж рдкреНрд░рд╛рд░рдВрдн
if (window.Sakha) {
  Sakha.speak("рд╕реНрд╡рд╛рдЧрдд рд╣реИ рд╢реНрд░реАрд╡рд┐рджреНрдпрд╛ рдЬреА, рдХреГрдкрдпрд╛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рд╛рд░рдВрдн рдХрд░реЗрдВред");
}

// ЁЯФР рдкреНрд░рд╛рд░рдВрднрд┐рдХ рд╕реНрдерд┐рддрд┐
let loginStage = 0;
let verifiedSession = false;

// ЁЯФ╣ рдПрдбрдорд┐рди рд▓реЙрдЧрд┐рди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкреНрд░рд╛рд░рдВрдн
async function initiateAdminLogin() {
  const pass = document.getElementById("adminPass").value.trim();
  const status = document.getElementById("login-status");

  status.textContent = "ЁЯФН рд╕рддреНрдпрд╛рдкрди рдЬрд╛рд░реА рд╣реИ...";
  status.style.color = "#ffc107";

  // 1я╕ПтГг рд╕рдЦрд╛ рд╡реНрдпрд╡рд╣рд╛рд░ рдЬрд╛рдВрдЪ
  if (!Sakha.processAction("admin", "loginAttempt", "gateway")) {
    Sakha.speak("рд╕реБрд░рдХреНрд╖рд╛ рдЪреЗрддрд╛рд╡рдиреА тАФ рдЕрд╕рд╛рдорд╛рдиреНрдп рдкреНрд░рдпрд╛рд╕ рдкрд╛рдпрд╛ рдЧрдпрд╛ред");
    alert("ЁЯЪл рд╕рдЦрд╛ рдиреЗ рд╕рдВрджрд┐рдЧреНрдз рд▓реЙрдЧрд┐рди рдкреНрд░рдпрд╛рд╕ рдХреЛ рд░реЛрдХ рджрд┐рдпрд╛ рд╣реИред");
    status.textContent = "тЭМ рд╕рдЦрд╛ рдиреЗ рдкреНрд░рдпрд╛рд╕ рд░реЛрдХрд╛ред";
    status.style.color = "red";
    return;
  }

  // 2я╕ПтГг рдкрд╛рд╕рд╡рд░реНрдб / рдорд╛рд╕реНрдЯрд░ рдХреА рд╕рддреНрдпрд╛рдкрди
  if (pass === "SV-MASTER" || pass === "ShriVidya@2025") {
    Sakha.speak("рдкрд╣рдЪрд╛рди рд╕рддреНрдпрд╛рдкрд┐рдд тАФ рджреНрд╡рд┐рддреАрдп рд╕реНрддрд░ рдкреНрд░рд╛рд░рдВрднред");
    console.log("тЬЕ Master Key verified successfully.");

    // 3я╕ПтГг Security Controller Validation
    const verified = await ShriVidyaSecurity.validateToken("adminLogin");

    if (verified) {
      verifiedSession = true;
      Sakha.speak("рд╕рднреА рд╕реНрддрд░ рд╕рдлрд▓ тАФ рдПрдбрдорд┐рди рдПрдХреНрд╕реЗрд╕ рдХреА рдЕрдиреБрдорддрд┐ред");
      status.textContent = "тЬЕ рдПрдбрдорд┐рди рд╕рддреНрдпрд╛рдкрди рд╕рдлрд▓!";
      status.style.color = "lime";
      setTimeout(() => {
        window.location.href = "admin.html";
      }, 2000);
    } else {
      Sakha.speak("рд╕рддреНрд░ рдЯреЛрдХрди рдЕрдорд╛рдиреНрдп тАФ рдХреГрдкрдпрд╛ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред");
      status.textContent = "тЪая╕П рдЯреЛрдХрди рд╕рддреНрдпрд╛рдкрди рд╡рд┐рдлрд▓ред";
      status.style.color = "orange";
    }
  } else {
    Sakha.speak("рдЧрд▓рдд рдкрд╛рд╕рд╡рд░реНрдбред рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред");
    alert("тЭМ рдЧрд▓рдд рдкрд╛рд╕рд╡рд░реНрдб / рдорд╛рд╕реНрдЯрд░ рдХреА!");
    status.textContent = "тЭМ рд▓реЙрдЧрд┐рди рд╡рд┐рдлрд▓ тАФ рдЧрд▓рдд рдкрд╛рд╕рд╡рд░реНрдбред";
    status.style.color = "red";
  }
}

// ЁЯФ╣ OTP рд╕рддреНрдпрд╛рдкрди (Fallback)
function verifyOTP() {
  const otp = document.getElementById("otpInput").value.trim();
  const status = document.getElementById("login-status");

  if (otp === "2025") {
    Sakha.speak("OTP рд╕рддреНрдпрд╛рдкрд┐рдд тАФ рдПрдХреНрд╕реЗрд╕ рд╕реНрд╡реАрдХреГрддред");
    status.textContent = "тЬЕ OTP рд╕рдлрд▓!";
    status.style.color = "lime";
    verifiedSession = true;
    setTimeout(() => {
      window.location.href = "admin.html";
    }, 1500);
  } else {
    Sakha.speak("OTP рдЕрд╕рдлрд▓ред рдХреГрдкрдпрд╛ рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред");
    alert("тЪая╕П рдЧрд▓рдд OTP!");
    status.textContent = "тЭМ OTP рдЕрд╕рдлрд▓ред";
    status.style.color = "red";
  }
}

// ЁЯМ┐ рд╕рдЦрд╛ рдкреБрдирдГ рд╕рдХреНрд░рд┐рдпрдг (рдЬрдм рдкреЗрдЬ idle рд╣реЛ рдЬрд╛рдП)
window.addEventListener("focus", () => {
  if (!verifiedSession) {
    Sakha.speak("рдЖрдкрдХрд╛ рд╕рддреНрд░ рдирд┐рд╖реНрдХреНрд░рд┐рдп рд╣реИ тАФ рдХреГрдкрдпрд╛ рдкреБрдирдГ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВред");
  }
});
